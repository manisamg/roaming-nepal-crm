<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roaming Nepal - Enterprise CRM</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #F3F4F6; }

        /* Login Page */
        .login-container {
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; background: linear-gradient(135deg, #1E3A8A 0%, #0D9488 100%);
        }
        .login-box {
            background: white; padding: 50px 40px; border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); width: 100%; max-width: 420px;
        }
        .login-logo { text-align: center; margin-bottom: 10px; }
        .login-logo-icon { font-size: 48px; margin-bottom: 10px; }
        .login-logo h1 { color: #1E3A8A; font-size: 28px; font-weight: 700; }
        .login-subtitle { text-align: center; color: #6B7280; margin-bottom: 40px; font-size: 14px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; color: #374151; font-weight: 500; }
        .form-group input {
            width: 100%; padding: 12px 15px; border: 1px solid #D1D5DB;
            border-radius: 6px; font-size: 15px;
        }
        .form-group input:focus { outline: none; border-color: #1E3A8A; box-shadow: 0 0 0 3px rgba(30, 58, 138, 0.1); }
        .login-btn {
            width: 100%; padding: 14px; background: #1E3A8A; color: white;
            border: none; border-radius: 6px; font-size: 16px; font-weight: 600;
            cursor: pointer; margin-top: 10px;
        }
        .login-btn:hover { background: #2563EB; }
        .error-message {
            background: #FEE2E2; color: #991B1B; padding: 12px;
            border-radius: 6px; margin-bottom: 20px; display: none;
        }

        /* Main App */
        .app-container { display: none; min-height: 100vh; }
        .top-nav {
            background: white; border-bottom: 1px solid #E5E7EB; padding: 0 30px;
            display: flex; justify-content: space-between; align-items: center;
            height: 70px; position: sticky; top: 0; z-index: 100;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .brand { display: flex; align-items: center; gap: 12px; font-size: 24px; font-weight: 700; color: #1E3A8A; }
        .user-menu { display: flex; align-items: center; gap: 15px; }
        .user-info { text-align: right; }
        .user-name { font-weight: 600; color: #111827; font-size: 14px; }
        .user-role { font-size: 12px; color: #6B7280; }
        .main-content { padding: 30px; max-width: 1800px; margin: 0 auto; }
        .page-title { font-size: 28px; font-weight: 700; color: #111827; margin-bottom: 25px; }

        /* KPI Cards */
        .kpi-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px; margin-bottom: 30px;
        }
        .kpi-card {
            background: white; padding: 25px; border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); transition: transform 0.3s;
        }
        .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
        .kpi-title { font-size: 14px; color: #6B7280; font-weight: 500; margin-bottom: 15px; }
        .kpi-value { font-size: 32px; font-weight: 700; color: #111827; margin-bottom: 8px; }
        .kpi-change { font-size: 14px; font-weight: 600; }
        .kpi-change.positive { color: #10B981; }
        .kpi-change.negative { color: #EF4444; }

        /* Chart */
        .chart-container {
            background: white; padding: 25px; border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 30px;
        }
        .chart-title { font-size: 18px; font-weight: 600; color: #111827; margin-bottom: 20px; }

        /* Recommendations */
        .recommendations {
            background: white; padding: 25px; border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); margin-bottom: 30px;
        }
        .recommendation-item {
            padding: 15px; border-left: 4px solid #6B7280; background: #F9FAFB;
            border-radius: 6px; margin-bottom: 15px;
        }
        .recommendation-item.urgent { border-left-color: #EF4444; background: #FEF2F2; }
        .recommendation-item.high { border-left-color: #F59E0B; background: #FFFBEB; }
        .recommendation-item.medium { border-left-color: #3B82F6; background: #EFF6FF; }
        .recommendation-priority { font-size: 12px; font-weight: 700; margin-bottom: 8px; }
        .recommendation-message { font-size: 15px; font-weight: 600; color: #111827; margin-bottom: 5px; }
        .recommendation-action { font-size: 14px; color: #6B7280; }

        /* Table */
        .data-table {
            background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            overflow: hidden;
        }
        .table-header {
            padding: 20px 25px; border-bottom: 1px solid #E5E7EB;
            display: flex; justify-content: space-between; align-items: center;
        }
        .table-title { font-size: 18px; font-weight: 600; color: #111827; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #F9FAFB; }
        th {
            padding: 15px 20px; text-align: left; font-weight: 600;
            font-size: 13px; color: #6B7280; text-transform: uppercase;
        }
        td { padding: 15px 20px; border-top: 1px solid #F3F4F6; font-size: 14px; color: #374151; }
        tbody tr:hover { background: #F9FAFB; }
        .airline-logo {
            width: 40px; height: 40px; border-radius: 50%; display: inline-flex;
            align-items: center; justify-content: center; color: white;
            font-weight: 700; font-size: 18px; margin-right: 10px;
        }
        .airline-cell { display: flex; align-items: center; }
        .badge {
            padding: 4px 12px; border-radius: 12px; font-size: 12px;
            font-weight: 600; display: inline-block;
        }
        .badge.green { background: #D1FAE5; color: #065F46; }
        .badge.yellow { background: #FEF3C7; color: #92400E; }
        .badge.red { background: #FEE2E2; color: #991B1B; }
        .btn {
            padding: 10px 20px; border: none; border-radius: 6px;
            font-size: 14px; font-weight: 600; cursor: pointer;
        }
        .btn-secondary { background: #E5E7EB; color: #374151; }
        .btn-secondary:hover { background: #D1D5DB; }
        .btn-primary { background: #1E3A8A; color: white; }
        .btn-primary:hover { background: #2563EB; }
        .btn-sm { padding: 6px 12px; font-size: 13px; }
        .hidden { display: none !important; }

        /* Loading Spinner */
        .loading { 
            display: inline-block; width: 16px; height: 16px;
            border: 2px solid #f3f3f3; border-top: 2px solid #1E3A8A;
            border-radius: 50%; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="login-container" id="loginPage">
    <div class="login-box">
        <div class="login-logo">
            <div class="login-logo-icon">‚úàÔ∏è</div>
            <h1>Roaming Nepal</h1>
        </div>
        <div class="login-subtitle">Enterprise Travel CRM System</div>

        <div class="error-message" id="loginError">Invalid username or password</div>

        <form id="loginForm">
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="username" required autocomplete="off">
            </div>
            <div class="form-group">
                <label>Password</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit" class="login-btn">Login</button>
        </form>

        <div style="text-align: center; margin-top: 20px;">
            <a href="#" style="color: #6B7280; text-decoration: none; font-size: 14px;">Forgot Password?</a>
        </div>
    </div>
</div>

<div class="app-container" id="appContainer">
    <nav class="top-nav">
        <div class="brand">
            <span>‚úàÔ∏è</span>
            <span>Roaming Nepal</span>
        </div>

        <div class="user-menu">
            <button class="btn btn-secondary btn-sm" onclick="loadAllDataFromSheets()" id="refreshBtn">
                üîÑ Refresh Data
            </button>
            <div class="user-info">
                <div class="user-name" id="userName">User</div>
                <div class="user-role" id="userRole">Role</div>
            </div>
            <button class="btn btn-secondary btn-sm" onclick="logout()">Logout</button>
        </div>
    </nav>

    <main class="main-content">
        <h1 class="page-title">Executive Dashboard</h1>

        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-title">Total Revenue (YTD)</div>
                <div class="kpi-value" id="revenueValue">Loading...</div>
                <div class="kpi-change positive" id="revenueChange">Loading...</div>
            </div>

            <div class="kpi-card">
                <div class="kpi-title">Total Bookings (YTD)</div>
                <div class="kpi-value" id="bookingsValue">Loading...</div>
                <div class="kpi-change positive" id="bookingsChange">Loading...</div>
            </div>

            <div class="kpi-card">
                <div class="kpi-title">IATA Credit Utilization</div>
                <div class="kpi-value" id="creditValue">Loading...</div>
                <div style="font-size: 14px; color: #6B7280; margin-top: 5px;" id="creditText">Loading...</div>
            </div>

            <div class="kpi-card">
                <div class="kpi-title">Active Customers</div>
                <div class="kpi-value" id="customersValue">Loading...</div>
                <div style="font-size: 14px; color: #6B7280; margin-top: 5px;" id="customersText">Loading...</div>
            </div>
        </div>

        <div class="chart-container">
            <h2 class="chart-title">Year-over-Year Revenue Growth</h2>
            <p style="color: #6B7280; margin-bottom: 20px;">Showing company direction: 2025 (Real Data from Google Sheets)</p>
            <canvas id="yoyChart" width="1000" height="300"></canvas>
        </div>

        <div class="recommendations">
            <h2 style="font-size: 20px; font-weight: 600; margin-bottom: 20px;">Strategic Recommendations for Board Review</h2>
            <div id="recommendationsContainer">
                <p style="color: #6B7280;">Loading recommendations...</p>
            </div>
        </div>

        <div class="data-table">
            <div class="table-header">
                <div class="table-title">Monthly Revenue Performance</div>
                <div>
                    <button class="btn btn-primary btn-sm" onclick="generateReport()">Generate Board Report</button>
                </div>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>Month</th>
                        <th>Revenue</th>
                        <th>Bookings</th>
                        <th>Avg Ticket</th>
                        <th>IATA Credit</th>
                        <th>Profit Margin</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="revenueTable">
                    <tr><td colspan="7" style="text-align: center; color: #6B7280;">Loading data from Google Sheets...</td></tr>
                </tbody>
            </table>
        </div>
    </main>
</div>

<script>
// ============================================
// GOOGLE SHEETS API CONFIGURATION
// ============================================
const SHEETS_CONFIG = {
    apiKey: 'AIzaSyDygZuhTi9eauI2PlBFBsg1_-a7gyrrBXE',
    spreadsheetId: '1RjQ2nrlyRLq1nn--M1-dyivdZAjTETRajW_9gwxWoyM',

    // Your sheet has a "Revenue" tab - we'll read from it
    ranges: {
        revenue: 'Revenue!A:K'  // All columns from your Revenue sheet
    }
};

// User credentials (stored securely - not visible on login page)
const users = {
    'ceo': { password: 'RN@CEO2025', role: 'CEO', name: 'Chief Executive Officer' },
    'board': { password: 'RN@Board2025', role: 'Board Member', name: 'Board Member' },
    'superadmin': { password: 'RN@Super2025', role: 'Super Admin', name: 'Super Administrator' },
    'admin': { password: 'RN@Admin2025', role: 'Admin', name: 'Admin User' },
    'user': { password: 'RN@User2025', role: 'User', name: 'Regular User' }
};

// Sample airline data (you can add an Airlines sheet later)
const sampleAirlines = [
    { name: 'Emirates', iata: 'EK', letter: 'E', color: '#C8102E', sales: 35600000, bookings: 685, share: 28.3, growth: 22, stock: 68, status: 'Healthy' },
    { name: 'Singapore Airlines', iata: 'SQ', letter: 'S', color: '#003D7A', sales: 32100000, bookings: 612, share: 25.6, growth: 18, stock: 2, status: 'Critical' },
    { name: 'Thai Airways', iata: 'TG', letter: 'T', color: '#7B1FA2', sales: 28500000, bookings: 812, share: 22.7, growth: 15, stock: 44, status: 'Low' },
    { name: 'Qatar Airways', iata: 'QR', letter: 'Q', color: '#5C0632', sales: 18900000, bookings: 326, share: 15.0, growth: 25, stock: 54, status: 'Healthy' },
    { name: 'IndiGo', iata: '6E', letter: 'I', color: '#001E62', sales: 10500000, bookings: 412, share: 8.4, growth: -3, stock: 218, status: 'Healthy' }
];

// Data cache
let appDataCache = {
    revenue: [],
    lastUpdated: null
};

// ============================================
// GOOGLE SHEETS DATA LOADING
// ============================================

async function fetchSheetData(range) {
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEETS_CONFIG.spreadsheetId}/values/${range}?key=${SHEETS_CONFIG.apiKey}`;

    try {
        console.log(`üì• Fetching data from: ${range}`);
        const response = await fetch(url);

        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(`API Error: ${errorData.error.message}`);
        }

        const data = await response.json();

        if (data.values && data.values.length > 0) {
            return parseSheetData(data.values);
        }

        console.warn(`‚ö†Ô∏è No data found in range: ${range}`);
        return [];

    } catch (error) {
        console.error(`‚ùå Error fetching ${range}:`, error);
        showNotification(`Failed to load data: ${error.message}`, 'error');
        return [];
    }
}

function parseSheetData(rows) {
    if (rows.length === 0) return [];

    const headers = rows[0];
    const data = [];

    for (let i = 1; i < rows.length; i++) {
        const row = rows[i];
        if (!row || row.length === 0) continue;

        const obj = {};
        headers.forEach((header, index) => {
            obj[header] = row[index] !== undefined ? row[index] : '';
        });
        data.push(obj);
    }

    console.log(`‚úÖ Parsed ${data.length} rows`);
    return data;
}

async function loadAllDataFromSheets() {
    console.log('üîÑ Loading data from Google Sheets...');

    const refreshBtn = document.getElementById('refreshBtn');
    if (refreshBtn) {
        refreshBtn.innerHTML = '<span class="loading"></span> Loading...';
        refreshBtn.disabled = true;
    }

    showNotification('Loading data from Google Sheets...', 'info');

    try {
        const revenue = await fetchSheetData(SHEETS_CONFIG.ranges.revenue);

        if (revenue.length === 0) {
            throw new Error('No data returned from sheet');
        }

        appDataCache.revenue = revenue;
        appDataCache.lastUpdated = new Date();

        console.log('‚úÖ Data loaded successfully');
        console.log('- Revenue records:', revenue.length);

        updateDashboardWithLiveData();
        showNotification('‚úÖ Data loaded successfully!', 'success');

    } catch (error) {
        console.error('‚ùå Error loading data:', error);
        showNotification('‚ùå Error loading data. Check console for details.', 'error');
    } finally {
        if (refreshBtn) {
            refreshBtn.innerHTML = 'üîÑ Refresh Data';
            refreshBtn.disabled = false;
        }
    }
}

function updateDashboardWithLiveData() {
    console.log('üìä Updating dashboard with live data...');

    if (appDataCache.revenue.length === 0) {
        console.warn('No data to display');
        return;
    }

    // Update KPIs
    updateKPIsFromSheets();

    // Update revenue table
    updateRevenueTableFromSheets();

    // Update chart
    updateChartsFromSheets();

    // Generate recommendations
    updateRecommendations();
}

function updateKPIsFromSheets() {
    // Find the TOTAL row or calculate totals
    let totalRow = appDataCache.revenue.find(row => row.Month === 'TOTAL');

    if (!totalRow) {
        // Calculate totals if TOTAL row doesn't exist
        totalRow = {
            Revenue: appDataCache.revenue.reduce((sum, row) => sum + (parseFloat(row.Revenue) || 0), 0),
            BookingsCount: appDataCache.revenue.reduce((sum, row) => sum + (parseInt(row.BookingsCount) || 0), 0),
            NewCustomers: appDataCache.revenue.reduce((sum, row) => sum + (parseInt(row.NewCustomers) || 0), 0),
            RepeatCustomers: appDataCache.revenue.reduce((sum, row) => sum + (parseInt(row.RepeatCustomers) || 0), 0)
        };
    }

    const totalRevenue = parseFloat(totalRow.Revenue) || 0;
    const totalBookings = parseInt(totalRow.BookingsCount) || 0;
    const newCustomers = parseInt(totalRow.NewCustomers) || 0;
    const repeatCustomers = parseInt(totalRow.RepeatCustomers) || 0;
    const totalCustomers = newCustomers + repeatCustomers;

    // Get IATA credit from last month's data
    const lastMonth = appDataCache.revenue.filter(row => row.Month !== 'TOTAL').pop();
    const iataCreditUsed = parseFloat(lastMonth?.IATACreditUsed) || 32500000;
    const iataCreditLimit = parseFloat(lastMonth?.IATACreditLimit) || 50000000;
    const creditPercent = ((iataCreditUsed / iataCreditLimit) * 100).toFixed(0);

    // Comparison with last year (sample data)
    const lastYearRevenue = 95800000;
    const lastYearBookings = 2215;
    const revenueGrowth = ((totalRevenue - lastYearRevenue) / lastYearRevenue * 100).toFixed(1);
    const bookingsGrowth = ((totalBookings - lastYearBookings) / lastYearBookings * 100).toFixed(1);

    // Update DOM
    document.getElementById('revenueValue').textContent = `NPR ${(totalRevenue / 1000000).toFixed(1)}M`;
    document.getElementById('revenueChange').textContent = `‚Üë ${revenueGrowth}% vs Last Year`;

    document.getElementById('bookingsValue').textContent = totalBookings.toLocaleString();
    document.getElementById('bookingsChange').textContent = `‚Üë ${bookingsGrowth}% vs Last Year`;

    document.getElementById('creditValue').textContent = `${creditPercent}%`;
    document.getElementById('creditText').textContent = `NPR ${(iataCreditUsed / 1000000).toFixed(1)}M / ${(iataCreditLimit / 1000000).toFixed(0)}M`;

    document.getElementById('customersValue').textContent = totalCustomers.toLocaleString();
    document.getElementById('customersText').textContent = `New: ${newCustomers} | Repeat: ${repeatCustomers}`;
}

function updateRevenueTableFromSheets() {
    const tbody = document.getElementById('revenueTable');
    if (!tbody) return;

    tbody.innerHTML = '';

    // Filter out TOTAL row for display
    const monthlyData = appDataCache.revenue.filter(row => row.Month !== 'TOTAL');

    monthlyData.forEach(row => {
        const revenue = parseFloat(row.Revenue) || 0;
        const bookings = parseInt(row.BookingsCount) || 0;
        const avgTicket = bookings > 0 ? revenue / bookings : 0;
        const iataCreditUsed = parseFloat(row.IATACreditUsed) || 0;
        const profitMargin = parseFloat(row.ProfitMarginPercent) || 0;

        // Determine status badge
        let statusBadge = '';
        if (profitMargin >= 19) {
            statusBadge = '<span class="badge green">Excellent</span>';
        } else if (profitMargin >= 18) {
            statusBadge = '<span class="badge green">Good</span>';
        } else {
            statusBadge = '<span class="badge yellow">Fair</span>';
        }

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><strong>${row.Month} ${row.Year}</strong></td>
            <td><strong>NPR ${(revenue / 1000000).toFixed(2)}M</strong></td>
            <td>${bookings.toLocaleString()}</td>
            <td>NPR ${avgTicket.toLocaleString('en-NP', {maximumFractionDigits: 0})}</td>
            <td>NPR ${(iataCreditUsed / 1000000).toFixed(1)}M</td>
            <td>${profitMargin}%</td>
            <td>${statusBadge}</td>
        `;
        tbody.appendChild(tr);
    });
}

function updateChartsFromSheets() {
    const monthlyData = appDataCache.revenue.filter(row => row.Month !== 'TOTAL');

    if (monthlyData.length === 0) return;

    const monthlyRevenue = monthlyData.map(row => parseFloat(row.Revenue) / 1000000);

    drawChartWithData(monthlyRevenue);
}

function drawChartWithData(currentYearData) {
    const canvas = document.getElementById('yoyChart');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Sample comparison data (you can add historical sheets later)
    const data = {
        current: currentYearData,
        last: [7.2, 7.8, 9.5, 8.9, 9.8, 10.2, 11.5, 10.5, 9.8, 10.6, 6.5],
        two: [6.1, 6.5, 8.0, 7.5, 8.2, 8.8, 9.8, 9.0, 8.3, 9.1, 5.5]
    };

    const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov'];

    // Draw grid
    ctx.strokeStyle = '#E5E7EB';
    ctx.lineWidth = 1;

    for (let i = 0; i <= 5; i++) {
        const y = 40 + (i * 50);
        ctx.beginPath();
        ctx.moveTo(60, y);
        ctx.lineTo(canvas.width - 20, y);
        ctx.stroke();

        ctx.fillStyle = '#6B7280';
        ctx.font = '12px sans-serif';
        ctx.textAlign = 'right';
        ctx.fillText(`${15 - i * 3}M`, 50, y + 4);
    }

    // Draw lines
    const drawLine = (lineData, color, lineWidth = 3) => {
        ctx.strokeStyle = color;
        ctx.lineWidth = lineWidth;
        ctx.beginPath();

        lineData.forEach((value, i) => {
            const x = 60 + (i * ((canvas.width - 80) / (lineData.length - 1)));
            const y = 40 + ((15 - value) * 50 / 3);

            if (i === 0) ctx.moveTo(x, y);
            else ctx.lineTo(x, y);
        });

        ctx.stroke();
    };

    drawLine(data.two, '#9CA3AF', 2);
    drawLine(data.last, '#10B981', 2.5);
    drawLine(data.current, '#1E3A8A', 3);

    // Legend
    const legendY = 20;
    ctx.fillStyle = '#1E3A8A';
    ctx.fillRect(canvas.width - 220, legendY, 30, 3);
    ctx.fillStyle = '#111827';
    ctx.font = '13px sans-serif';
    ctx.textAlign = 'left';
    ctx.fillText('2025 (Live from Google Sheets)', canvas.width - 185, legendY + 3);

    ctx.fillStyle = '#10B981';
    ctx.fillRect(canvas.width - 220, legendY + 20, 30, 3);
    ctx.fillText('2024 (Sample)', canvas.width - 185, legendY + 23);

    ctx.fillStyle = '#9CA3AF';
    ctx.fillRect(canvas.width - 220, legendY + 40, 30, 3);
    ctx.fillText('2023 (Sample)', canvas.width - 185, legendY + 43);

    // X-axis
    ctx.fillStyle = '#6B7280';
    ctx.textAlign = 'center';
    months.forEach((month, i) => {
        const x = 60 + (i * ((canvas.width - 80) / (months.length - 1)));
        ctx.fillText(month, x, canvas.height - 10);
    });
}

function updateRecommendations() {
    const container = document.getElementById('recommendationsContainer');
    if (!container) return;

    const monthlyData = appDataCache.revenue.filter(row => row.Month !== 'TOTAL');
    const lastMonth = monthlyData[monthlyData.length - 1];

    const creditUsed = parseFloat(lastMonth?.IATACreditUsed) || 0;
    const creditLimit = parseFloat(lastMonth?.IATACreditLimit) || 0;
    const creditPercent = (creditUsed / creditLimit * 100).toFixed(0);

    let recommendations = '';

    // Check IATA credit
    if (creditPercent >= 65) {
        recommendations += `
            <div class="recommendation-item high">
                <div class="recommendation-priority" style="color: #F59E0B;">üü° HIGH PRIORITY</div>
                <div class="recommendation-message">IATA Credit: ${creditPercent}% utilized (${(creditUsed/1000000).toFixed(1)}M / ${(creditLimit/1000000).toFixed(0)}M)</div>
                <div class="recommendation-action">Action: Initiate credit limit increase to 75M. Timeline: Begin 2-3 months before reaching 85%</div>
            </div>
        `;
    }

    // Growth trend
    const totalRow = appDataCache.revenue.find(row => row.Month === 'TOTAL');
    const totalRevenue = parseFloat(totalRow?.Revenue) || 0;
    if (totalRevenue > 120000000) {
        recommendations += `
            <div class="recommendation-item medium">
                <div class="recommendation-priority" style="color: #3B82F6;">üîµ POSITIVE TREND</div>
                <div class="recommendation-message">Revenue target exceeded: NPR ${(totalRevenue/1000000).toFixed(1)}M achieved</div>
                <div class="recommendation-action">Action: Maintain current sales strategy and consider expanding team</div>
            </div>
        `;
    }

    // Sample airline recommendations
    recommendations += `
        <div class="recommendation-item urgent">
            <div class="recommendation-priority" style="color: #EF4444;">üî¥ URGENT</div>
            <div class="recommendation-message">Singapore Airlines: Only 2 tickets remaining</div>
            <div class="recommendation-action">Action: Immediate restocking required. Contact Li Wei (+65-6-1234567)</div>
        </div>
        <div class="recommendation-item medium">
            <div class="recommendation-priority" style="color: #3B82F6;">üîµ PLANNING</div>
            <div class="recommendation-message">Peak Season Alert: Dec-Jan demand surge expected</div>
            <div class="recommendation-action">Action: Pre-book Dubai & Bangkok inventory now. Historical: 35-40% booking increase</div>
        </div>
    `;

    container.innerHTML = recommendations;
}

function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed; top: 20px; right: 20px; padding: 15px 20px;
        background: ${type === 'success' ? '#10B981' : type === 'error' ? '#EF4444' : '#3B82F6'};
        color: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        z-index: 10000; font-size: 14px; font-weight: 500;
    `;
    notification.textContent = message;
    document.body.appendChild(notification);
    setTimeout(() => notification.remove(), 3000);
}

// ============================================
// LOGIN & UI
// ============================================

document.getElementById('loginForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value;

    if (users[username] && users[username].password === password) {
        document.getElementById('loginPage').style.display = 'none';
        document.getElementById('appContainer').style.display = 'block';
        document.getElementById('userName').textContent = users[username].name;
        document.getElementById('userRole').textContent = users[username].role;

        // Load data from Google Sheets after login
        await loadAllDataFromSheets();

    } else {
        document.getElementById('loginError').style.display = 'block';
        setTimeout(() => {
            document.getElementById('loginError').style.display = 'none';
        }, 3000);
    }
});

function generateReport() {
    alert('üìÑ Board Report Generated!\n\nReport Type: Executive Summary\nData Source: Google Sheets (Live)\nDate Range: YTD 2025\n\nIn production, this would download a PDF with all metrics and charts.');
}

function logout() {
    if (confirm('Are you sure you want to logout?')) {
        location.reload();
    }
}

// Auto-refresh every 5 minutes
setInterval(function() {
    if (document.getElementById('appContainer').style.display !== 'none') {
        console.log('‚è∞ Auto-refreshing data...');
        loadAllDataFromSheets();
    }
}, 5 * 60 * 1000);

// Log configuration on page load
console.log('‚úÖ Roaming Nepal CRM initialized');
console.log('üìä Google Sheets Configuration:');
console.log('   Spreadsheet ID:', SHEETS_CONFIG.spreadsheetId);
console.log('   API Key: [PROTECTED]');
console.log('üîÑ Auto-refresh: Every 5 minutes');
</script>

</body>
</html>